<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title th:text="${title} ?: 'Kraft Admin'">Kraft Admin</title>

  <link rel="stylesheet" th:href="@{/css/app.css}">
  <!-- Select2 and Choices.js -->
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
  <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet" />
</head>

<body class="bg-slate-200">

<!-- Wrapper -->
<div class="flex">

  <!-- Sidebar -->
      <div th:replace="~{components/sidebar :: sidebar-container}"></div>

  <!-- Page Content (shifted to the right of sidebar) -->
  <div class="flex-1 flex flex-col">

    <!-- Top Navbar -->
    <div class="sticky top-0 bg-white shadow-md z-40">
      <div th:replace="~{components/navbar :: navbar-container}"></div>
    </div>

    <!-- Main Content -->
    <main class="flex-1 p-4">
      <div class="text-gray-500 text-sm text-right mb-2">
        Request processed in <span th:text="${responseTime}">--</span>
      </div>
      <div th:replace="~{components/snackbar :: toast-container}"></div>
      <th:block layout:fragment="content"></th:block>
    </main>

  </div>
</div>

<script th:src="@{/js/script.js}" defer></script>

<script>
  document.addEventListener('DOMContentLoaded', function () {
      const selectAllCheckbox = document.getElementById('selectAll');
      const rowCheckboxes = document.querySelectorAll('.rowCheckbox');

      // Helper to update row style
      const updateRowStyle = (checkbox) => {
          const row = checkbox.closest('tr');
          if (checkbox.checked) {
              row.classList.add('selected');
          } else {
              row.classList.remove('selected');
          }
      };

      // Handle select all checkbox
      selectAllCheckbox.addEventListener('change', function () {
          rowCheckboxes.forEach(cb => {
              cb.checked = this.checked;
              updateRowStyle(cb);
          });
    updateBulkActionsVisibility();
      });

      // Handle individual row checkbox changes
      rowCheckboxes.forEach(cb => {
          cb.addEventListener('change', function () {
              updateRowStyle(this);

              // Update selectAll checkbox state
              const allChecked = Array.from(rowCheckboxes).every(cb => cb.checked);
              selectAllCheckbox.checked = allChecked;
    updateBulkActionsVisibility();
              });

          // Apply initial style if pre-selected (optional, e.g., after form resubmit)
          if (cb.checked) {
              updateRowStyle(cb);
          }
      });

      function updateBulkActionsVisibility() {
       console.log("update bulkActions visibility");
        const bulkActions = document.getElementById("bulkActions");
        const anyChecked = Array.from(rowCheckboxes).some(cb => cb.checked);

        if (anyChecked) {
            bulkActions.classList.remove("hidden");
        } else {
            bulkActions.classList.add("hidden");
        }
    }
  });

  function toggleActions(button) {
     const dropdown = button.nextElementSibling;
     const isVisible = dropdown.style.display === 'block';

     // Close all open dropdowns first
     document.querySelectorAll('.actions-menu').forEach(menu => {
         menu.style.display = 'none';
     });

     dropdown.style.display = isVisible ? 'none' : 'block';
 }

 // Optional: Close dropdowns when clicking outside
 window.addEventListener('click', function(event) {
     if (!event.target.closest('.action-dropdown')) {
         document.querySelectorAll('.actions-menu').forEach(menu => {
             menu.style.display = 'none';
         });
     }
 });

 // show delete modal
<!-- function showDeleteModal(id, entityName) {-->
<!--      const form = document.getElementById("deleteForm");-->
<!--      form.action = `/admin/${entityName}/delete/${id}`;-->
<!--      document.getElementById("deleteModal").style.display = "flex";-->
<!-- }-->

function showDeleteModal(itemId, entityName) {
    const form = document.getElementById('deleteForm');
    form.action = `/admin/${entityName}/delete/${itemId}`;
    document.getElementById('deleteModal').style.display = 'flex';
}

 function closeDeleteModal() {
      document.getElementById("deleteModal").style.display = "none";
 }

  // perform bulk action
  function performBulkAction(action) {
        const selectedIds = Array.from(document.querySelectorAll('.rowCheckbox:checked'))
            .map(cb => cb.value)
            .join(',');

        const entityName = '[[${entityName}]]'; // Thymeleaf inline

        if (!selectedIds) {
            alert('Please select at least one item.');
            return;
        }

        if (action === 'delete' && !confirm('Are you sure you want to delete the selected items?')) {
            return;
        }

        const url = `/admin/${entityName}/bulk-action?action=${action}&selectedIds=${selectedIds}`;
        window.location.href = url;
    }

    function confirmDeleteSingle(id, entityName) {
        if (confirm("Are you sure you want to delete this item?")) {
            window.location.href = `/admin/${entityName}/delete/${id}`;
        }
    }

    // show bulk actions fragment
<!--    function showBulkActions() {-->
<!--        const bulkActions = document.getElementById("bulkActions");-->
<!--        bulkActions.classList.toggle("hidden");-->
<!--    }-->


   // Function to filter the options based on the search input
  function filterSelectOptions(selectId) {
      console.log("in searchselectinput field");
    var input = document.getElementById(selectId + '-search');
    var filter = input.value.toLowerCase();
    var select = document.getElementById(selectId);
    var options = select.getElementsByTagName('option');

    // Loop through all options and hide those that don't match the search term
    for (var i = 0; i < options.length; i++) {
      var option = options[i];
      var text = option.textContent || option.innerText;

      // Check if the option text matches the search term
      if (text.toLowerCase().indexOf(filter) > -1) {
        option.style.display = ''; // Show matching option
      } else {
        option.style.display = 'none'; // Hide non-matching option
      }
    }
  }

  // wysiwyg
<!--   document.addEventListener('DOMContentLoaded', function () {-->
<!--      const editor = new Quill('.quill-editor', { theme: 'snow' });-->
<!--      const input = document.getElementById('quillInput');-->
<!--      console.log(input);-->
<!--      editor.on('text-change', function () {-->
<!--        input.value = editor.root.innerHTML;-->
<!--      });-->

<!--      // Set initial content if available-->
<!--      editor.root.innerHTML = input.value;-->
<!--    });-->

  document.addEventListener('DOMContentLoaded', function () {
    const editors = document.querySelectorAll('.quill-editor');

    editors.forEach(editorDiv => {
      const fieldName = editorDiv.getAttribute('data-target');
      const input = document.getElementById(`${fieldName}-input`);

      const quill = new Quill(`#${editorDiv.id}`, { theme: 'snow' });

      // Set initial content if available
      if (input.value) {
        quill.root.innerHTML = input.value;
      }

      // Sync content on change
      quill.on('text-change', function () {
        input.value = quill.root.innerHTML;
      });
    });
  });

</script>


</body>
</html>
